<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SGE Accounting File • wyntonquery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SGE Accounting File">
<meta property="og:description" content="wyntonquery">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">wyntonquery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0-9003</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/qstat.html">Jobs on the SGE queue</a>
    </li>
    <li>
      <a href="../articles/sge_accounting_file.html">SGE Accounting File</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ucsf-wynton/wyntonquery/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SGE Accounting File</h1>
                        <h4 data-toc-skip class="author">Henrik
Bengtsson</h4>
            
            <h4 data-toc-skip class="date">2021-10-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ucsf-wynton/wyntonquery/blob/HEAD/vignettes/sge_accounting_file.Rmd" class="external-link"><code>vignettes/sge_accounting_file.Rmd</code></a></small>
      <div class="hidden name"><code>sge_accounting_file.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The SGE accounting file holds information on all submitted and
<em>finished</em> jobs submitted to the SGE scheduler. Queued or
currently running jobs are <em>not</em> included in this file. A job is
considered “finished” if it completed successfully, terminated due to an
error, or was cancelled. The file is a colon-delimited text file with
one job entry per row, with the most recently finished job appended at
end. Contrary to what one might expect, the file is not
<em>perfectly</em> ordered by the <code>end_time</code> of the jobs. We
might find some entries where the <code>end_time</code> of two
consequentive entries might differ by a few seconds in the “wrong”
order. It’s not clear to me why this is but it might be that the
scheduler updates the SGE accounting file at regular intervals, say
every few minutes, and when it does it goes through the jobs in order of
job index.</p>
</div>
<div class="section level2">
<h2 id="indexing-the-sge-accounting-file">Indexing the SGE accounting file<a class="anchor" aria-label="anchor" href="#indexing-the-sge-accounting-file"></a>
</h2>
<p>In March 2020, the Wynton HPC accounting file was ~12 GB and took 6-8
minutes to read. In June 2021, it was ~58 GB and had 161 million job
entries. In October 2021, it was ~69 GB and had 192 million job entries.
It is rare to be interested in all entries. It is more common to work
with a subset of the job entries. In order to do this efficiently, we
start by indexing the SGE accounting file to identify the file byte
offset for each job entry;</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ucsf-wynton/wyntonquery" class="external-link">wyntonquery</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://progressr.futureverse.org" class="external-link">progressr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span>global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">## Report on progress</span></span>
<span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span><span class="fu"><a href="https://progressr.futureverse.org/reference/handler_progress.html" class="external-link">handler_progress</a></span><span class="op">(</span></span>
<span>  <span class="st">":spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pathname</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sge_accounting_file.html">sge_accounting_file</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"File size: %.3g GB\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="va">pathname</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; File size: 69.3 GB</span></span>
<span></span>
<span><span class="co">## It takes ~15 minutes to index a 69 GB SGE accounting file</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_file_index.html">make_file_index</a></span><span class="op">(</span><span class="va">pathname</span>, skip <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Number of job entries: %d\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of job entries: 191745505</span></span>
<span></span>
<span><span class="co">## Save per-job index to file</span></span>
<span><span class="fu"><a href="../reference/make_file_index.html">save_file_index</a></span><span class="op">(</span><span class="va">index</span>, file <span class="op">=</span> <span class="st">"accounting.index_by_row"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we want to group the job entries by the ISO-6801 week of the
job end times.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ucsf-wynton/wyntonquery" class="external-link">wyntonquery</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://progressr.futureverse.org" class="external-link">progressr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span>global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">## Report on progress</span></span>
<span><span class="fu"><a href="https://progressr.futureverse.org/reference/handlers.html" class="external-link">handlers</a></span><span class="op">(</span><span class="fu"><a href="https://progressr.futureverse.org/reference/handler_progress.html" class="external-link">handler_progress</a></span><span class="op">(</span></span>
<span>  <span class="st">":spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pathname</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sge_accounting_file.html">sge_accounting_file</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_file_index.html">read_file_index</a></span><span class="op">(</span><span class="st">"accounting.index_by_row"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Number of job entries: %d\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of job entries: 191745505</span></span>
<span></span>
<span><span class="co">## It takes ~15 minutes to build the week index for 192 million entries</span></span>
<span><span class="va">week_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sge_make_week_index.html">sge_make_week_index</a></span><span class="op">(</span><span class="va">pathname</span>, index <span class="op">=</span> <span class="va">index</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">week_index</span>, file <span class="op">=</span> <span class="st">"accounting.index_by_week.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">week_index</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 218 × 3</span></span>
<span><span class="co">#&gt;    week    nbr_of_jobs file_offset</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2017W33         406          59</span></span>
<span><span class="co">#&gt;  2 2017W34          44      113195</span></span>
<span><span class="co">#&gt;  3 2017W35          49      127727</span></span>
<span><span class="co">#&gt;  4 2017W36          24      143361</span></span>
<span><span class="co">#&gt;  5 2017W37           8      150740</span></span>
<span><span class="co">#&gt;  6 2017W38          30      153559</span></span>
<span><span class="co">#&gt;  7 2017W39          18      163657</span></span>
<span><span class="co">#&gt;  8 2017W40          22      169804</span></span>
<span><span class="co">#&gt;  9 2017W41           2      177075</span></span>
<span><span class="co">#&gt; 10 2017W42          18      177695</span></span>
<span><span class="co">#&gt; # … with 208 more rows</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reading-job-entries-in-sge-accounting-file">Reading job entries in SGE accounting file<a class="anchor" aria-label="anchor" href="#reading-job-entries-in-sge-accounting-file"></a>
</h2>
<p>Here is an example how we can read the job entries for a couple of
weeks:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ucsf-wynton/wyntonquery" class="external-link">wyntonquery</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pathname</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sge_accounting_file.html">sge_accounting_file</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">week_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"accounting.index_by_week.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">week_index</span>, <span class="va">week</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020W06"</span>, <span class="st">"2020W07"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">weeks</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span><span class="co">#&gt;   week    nbr_of_jobs file_offset</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2020W06      627479 11015936052</span></span>
<span><span class="co">#&gt; 2 2020W07      663484 11229385140</span></span>
<span></span>
<span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="va">weeks</span><span class="op">$</span><span class="va">file_offset</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">n_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">weeks</span><span class="op">$</span><span class="va">nbr_of_jobs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Number of job entries to read: %d\n"</span>, <span class="va">n_max</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of job entries to read: 1290963</span></span>
<span></span>
<span><span class="co">## It takes ~5 seconds to read the ~1.3 million job entries of interest</span></span>
<span><span class="va">jobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_sge_accounting.html">read_sge_accounting</a></span><span class="op">(</span><span class="va">pathname</span>, offset <span class="op">=</span> <span class="va">offset</span>, n_max <span class="op">=</span> <span class="va">n_max</span><span class="op">)</span></span>
<span><span class="va">jobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/anonymize.html">anonymize</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="op">-</span><span class="va">account</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 44</span></span>
<span><span class="co">#&gt;    qname  hostname group owner job_name  job_number priority submission_time    </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;          &lt;int&gt;    &lt;int&gt; &lt;dttm&gt;             </span></span>
<span><span class="co">#&gt;  1 long.q cc-id3   grou… owne… job_qb3.…        361       19 2017-10-24 09:33:46</span></span>
<span><span class="co">#&gt;  2 long.q cin-id2  grou… owne… job_qb3.…        360       19 2017-10-23 16:09:59</span></span>
<span><span class="co">#&gt;  3 long.q qb3-hmi… grou… owne… job_qb3.…        365       19 2017-10-24 12:01:17</span></span>
<span><span class="co">#&gt;  4 long.q qb3-id3  grou… owne… job_mac_…        359       19 2017-10-23 09:52:44</span></span>
<span><span class="co">#&gt;  5 long.q qb3-id2  grou… owne… job_qb3.…        363       19 2017-10-24 09:41:57</span></span>
<span><span class="co">#&gt;  6 long.q qb3-id1  grou… owne… bmle_int…        368       19 2017-10-25 09:21:41</span></span>
<span><span class="co">#&gt; # … with 36 more rows, and 36 more variables: start_time &lt;dttm&gt;,</span></span>
<span><span class="co">#&gt; #   end_time &lt;dttm&gt;, failed &lt;int&gt;, exit_status &lt;int&gt;, ru_wallclock &lt;drtn&gt;,</span></span>
<span><span class="co">#&gt; #   ru_utime &lt;drtn&gt;, ru_stime &lt;drtn&gt;, ru_maxrss &lt;chr&gt;, ru_ixrss &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   ru_ismrss &lt;chr&gt;, ru_idrss &lt;chr&gt;, ru_isrss &lt;chr&gt;, ru_minflt &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   ru_majflt &lt;dbl&gt;, ru_nswap &lt;dbl&gt;, ru_inblock &lt;dbl&gt;, ru_oublock &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   ru_msgsnd &lt;dbl&gt;, ru_msgrcv &lt;dbl&gt;, ru_nsignals &lt;dbl&gt;, ru_nvcsw &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   ru_nivcsw &lt;dbl&gt;, project &lt;chr&gt;, department &lt;chr&gt;, granted_pe &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   slots &lt;int&gt;, task_number &lt;int&gt;, cpu &lt;drtn&gt;, mem &lt;chr&gt;, io &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   category &lt;chr&gt;, iow &lt;drtn&gt;, pe_taskid &lt;chr&gt;, maxvmem &lt;dbl&gt;, arid &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   ar_sub_time &lt;dttm&gt;</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="statistics-on-these-jobs">Statistics on these jobs<a class="anchor" aria-label="anchor" href="#statistics-on-these-jobs"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">$</span><span class="va">end_time</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Period: %s/%s\n"</span>, <span class="va">period</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">period</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Period: 2020-02-03 00:00:01/2020-02-16 23:59:58</span></span>
<span></span>
<span><span class="va">jobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_weeks.html">add_weeks</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span></span>
<span><span class="va">period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">$</span><span class="va">end_time_week</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Period (weeks): %s/%s\n"</span>, <span class="va">period</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">period</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Period (weeks): Period: 2020W06/2020W07</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Number of jobs finished during this period: %d\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of jobs finished during this period: 1290963</span></span>
<span></span>
<span><span class="va">nusers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">$</span><span class="va">owner</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Number of unique users: %d\n"</span>, <span class="va">nusers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of unique users: 146</span></span></code></pre></div>
<p>Let’s see how many of the jobs finished succesfully and how many
failed.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Get successful and failed jobs</span></span>
<span><span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  success <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">failed</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span>,</span>
<span>  fail    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">failed</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">groups</span>, <span class="va">nrow</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="co">#&gt; success    fail </span></span>
<span><span class="co">#&gt; 1227507   63456</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">stats</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  success     fail </span></span>
<span><span class="co">#&gt; 0.950846 0.049154</span></span></code></pre></div>
<p>We see that failure rate among the ~1.3 million jobs that ran during
this period was ~5%. Next, let’s see how much CPU time this corresponds
to:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## CPU time consumed</span></span>
<span><span class="va">cpu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">groups</span>, <span class="kw">function</span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span> <span class="op">{</span> <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">$</span><span class="va">cpu</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">units</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"days"</span>; <span class="va">d</span> <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cpu</span><span class="op">)</span>, cpu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">cpu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Total CPU processing time: %.1f %s\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">total</span><span class="op">$</span><span class="va">cpu</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">units</a></span><span class="op">(</span><span class="va">total</span><span class="op">$</span><span class="va">cpu</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Total CPU processing time: 53069.7 days</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span></span>
<span><span class="co">#&gt;   outcome cpu          </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;drtn&gt;       </span></span>
<span><span class="co">#&gt; 1 success 37291.05 days</span></span>
<span><span class="co">#&gt; 2 fail    15778.61 days</span></span>
<span></span>
<span><span class="co">## CPU-time fractions</span></span>
<span><span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">total</span>, cpu <span class="op">=</span> <span class="op">{</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cpu</span><span class="op">)</span>; <span class="va">x</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ratio</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   outcome   cpu</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 success 0.703</span></span>
<span><span class="co">#&gt; 2 fail    0.297</span></span></code></pre></div>
<p>From this, we find that during these two weeks, ~30% of the CPU time
was consumed by jobs that failed. Among the failed jobs, the failure
code was distributed as:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">codes</span> <span class="op">&lt;-</span> <span class="va">groups</span><span class="op">$</span><span class="va">fail</span><span class="op">$</span><span class="va">failed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">codes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    1     8    19    21    26    27    28    37   100 </span></span>
<span><span class="co">#&gt;    8    26  2520     8  2762    15 15552  9907 32658</span></span></code></pre></div>
<p>From details on these codes, see
<code><a href="../reference/read_sge_accounting.html">help("read_sge_accounting", package="wyntonquery")</a></code>, or:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu"><a href="../reference/sge_failed_codes.html">sge_failed_codes</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">Code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">codes</span><span class="op">)</span>, select<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Code</span>, <span class="va">Explanation</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 9 × 2</span></span>
<span><span class="co">#&gt;    Code Explanation                                                                                                       </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;                                                                                                             </span></span>
<span><span class="co">#&gt; 1     1 failed early in execd</span></span>
<span><span class="co">#&gt; 2     8 failed in prolog</span></span>
<span><span class="co">#&gt; 3    19 shepherd didnt write reports correctly - probably program or machine crash</span></span>
<span><span class="co">#&gt; 4    21 qmaster asked about an unknown job (not in accounting?)</span></span>
<span><span class="co">#&gt; 5    26 failed opening stderr/stdout file</span></span>
<span><span class="co">#&gt; 6    27 failed finding specified shell</span></span>
<span><span class="co">#&gt; 7    28 failed changing to start directory</span></span>
<span><span class="co">#&gt; 8    37 ran, but killed due to exceeding run time limit</span></span>
<span><span class="co">#&gt; 9   100 ran, but killed by a signal (perhaps due to exceeding resources),</span></span>
<span><span class="co">#&gt;         task died, shepherd died (e.g. node crash), etc.</span></span></code></pre></div>
<p>The jobs that exhausted their limits, consumed 9,613 days of CPU
time;</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">groups</span><span class="op">$</span><span class="va">fail</span>, <span class="va">failed</span> <span class="op">==</span> <span class="fl">37</span><span class="op">)</span><span class="op">$</span><span class="va">cpu</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">units</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"days"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co"># Time difference of 9613.036 days</span></span></code></pre></div>
<p>which corresponds to ~18% of all CPU time spent:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">as.numeric</span>(d)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">as.numeric</span>(total<span class="sc">$</span>cpu))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.1811399</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Henrik Bengtsson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
