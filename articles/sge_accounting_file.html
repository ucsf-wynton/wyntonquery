<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Henrik Bengtsson" />

<meta name="date" content="2021-10-14" />

<title>SGE Accounting File</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">SGE Accounting File</h1>
<h4 class="author">Henrik Bengtsson</h4>
<h4 class="date">2021-10-14</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The SGE accounting file holds information on all submitted and
<em>finished</em> jobs submitted to the SGE scheduler. Queued or
currently running jobs are <em>not</em> included in this file. A job is
considered “finished” if it completed successfully, terminated due to an
error, or was cancelled. The file is a colon-delimited text file with
one job entry per row, with the most recently finished job appended at
end. Contrary to what one might expect, the file is not
<em>perfectly</em> ordered by the <code>end_time</code> of the jobs. We
might find some entries where the <code>end_time</code> of two
consequentive entries might differ by a few seconds in the “wrong”
order. It’s not clear to me why this is but it might be that the
scheduler updates the SGE accounting file at regular intervals, say
every few minutes, and when it does it goes through the jobs in order of
job index.</p>
</div>
<div id="indexing-the-sge-accounting-file" class="section level2">
<h2>Indexing the SGE accounting file</h2>
<p>In March 2020, the Wynton HPC accounting file was ~12 GB and took 6-8
minutes to read. In June 2021, it was ~58 GB and had 161 million job
entries. In October 2021, it was ~69 GB and had 192 million job entries.
It is rare to be interested in all entries. It is more common to work
with a subset of the job entries. In order to do this efficiently, we
start by indexing the SGE accounting file to identify the file byte
offset for each job entry;</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(wyntonquery)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(progressr)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">handlers</span>(<span class="at">global =</span> <span class="cn">TRUE</span>) <span class="do">## Report on progress</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">handlers</span>(<span class="fu">handler_progress</span>(</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="st">&quot;:spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>))</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>pathname <span class="ot">&lt;-</span> <span class="fu">sge_accounting_file</span>()</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;File size: %.3g GB</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">file.size</span>(pathname)<span class="sc">/</span><span class="dv">1000</span><span class="sc">^</span><span class="dv">3</span>))</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#&gt; File size: 69.3 GB</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="do">## It takes ~15 minutes to index a 69 GB SGE accounting file</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">make_file_index</span>(pathname, <span class="at">skip =</span> <span class="dv">4</span><span class="dt">L</span>)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Number of job entries: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">length</span>(index)))</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#&gt; Number of job entries: 191745505</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="do">## Save per-job index to file</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="fu">save_file_index</span>(index, <span class="at">file =</span> <span class="st">&quot;accounting.index_by_row&quot;</span>)</span></code></pre></div>
<p>Next, we want to group the job entries by the ISO-6801 week of the
job end times.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(wyntonquery)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(progressr)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">handlers</span>(<span class="at">global =</span> <span class="cn">TRUE</span>) <span class="do">## Report on progress</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">handlers</span>(<span class="fu">handler_progress</span>(</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="st">&quot;:spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>))</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>pathname <span class="ot">&lt;-</span> <span class="fu">sge_accounting_file</span>()</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">read_file_index</span>(<span class="st">&quot;accounting.index_by_row&quot;</span>)</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Number of job entries: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">length</span>(index)))</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co">#&gt; Number of job entries: 191745505</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="do">## It takes ~15 minutes to build the week index for 192 million entries</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>week_index <span class="ot">&lt;-</span> <span class="fu">sge_make_week_index</span>(pathname, <span class="at">index =</span> index)</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="fu">saveRDS</span>(week_index, <span class="at">file =</span> <span class="st">&quot;accounting.index_by_week.rds&quot;</span>)</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="fu">print</span>(week_index)</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co">#&gt; # A tibble: 218 × 3</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="co">#&gt;    week    nbr_of_jobs file_offset</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a><span class="co">#&gt;  1 2017W33         406          59</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co">#&gt;  2 2017W34          44      113195</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="co">#&gt;  3 2017W35          49      127727</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="co">#&gt;  4 2017W36          24      143361</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a><span class="co">#&gt;  5 2017W37           8      150740</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a><span class="co">#&gt;  6 2017W38          30      153559</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a><span class="co">#&gt;  7 2017W39          18      163657</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="co">#&gt;  8 2017W40          22      169804</span></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a><span class="co">#&gt;  9 2017W41           2      177075</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a><span class="co">#&gt; 10 2017W42          18      177695</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a><span class="co">#&gt; # … with 208 more rows</span></span></code></pre></div>
</div>
<div id="reading-job-entries-in-sge-accounting-file" class="section level2">
<h2>Reading job entries in SGE accounting file</h2>
<p>Here is an example how we can read the job entries for a couple of
weeks:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">library</span>(wyntonquery)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>pathname <span class="ot">&lt;-</span> <span class="fu">sge_accounting_file</span>()</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>week_index <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;accounting.index_by_week.rds&quot;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>weeks <span class="ot">&lt;-</span> <span class="fu">subset</span>(week_index, week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;2020W06&quot;</span>, <span class="st">&quot;2020W07&quot;</span>))</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="fu">print</span>(weeks)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;   week    nbr_of_jobs file_offset</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt; 1 2020W06      627479 11015936052</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; 2 2020W07      663484 11229385140</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>offset <span class="ot">&lt;-</span> weeks<span class="sc">$</span>file_offset[<span class="dv">1</span>]</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>n_max <span class="ot">&lt;-</span> <span class="fu">sum</span>(weeks<span class="sc">$</span>nbr_of_jobs)</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Number of job entries to read: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, n_max))</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt; Number of job entries to read: 1290963</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="do">## It takes ~5 seconds to read the ~1.3 million job entries of interest</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> <span class="fu">read_sge_accounting</span>(pathname, <span class="at">offset =</span> offset, <span class="at">n_max =</span> n_max)</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> <span class="fu">anonymize</span>(jobs)</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(<span class="fu">select</span>(jobs, <span class="sc">-</span>account)))</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="co">#&gt; # A tibble: 6 × 44</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="co">#&gt;    qname  hostname group owner job_name  job_number priority submission_time    </span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;          &lt;int&gt;    &lt;int&gt; &lt;dttm&gt;             </span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="co">#&gt;  1 long.q cc-id3   grou… owne… job_qb3.…        361       19 2017-10-24 09:33:46</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a><span class="co">#&gt;  2 long.q cin-id2  grou… owne… job_qb3.…        360       19 2017-10-23 16:09:59</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a><span class="co">#&gt;  3 long.q qb3-hmi… grou… owne… job_qb3.…        365       19 2017-10-24 12:01:17</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a><span class="co">#&gt;  4 long.q qb3-id3  grou… owne… job_mac_…        359       19 2017-10-23 09:52:44</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a><span class="co">#&gt;  5 long.q qb3-id2  grou… owne… job_qb3.…        363       19 2017-10-24 09:41:57</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a><span class="co">#&gt;  6 long.q qb3-id1  grou… owne… bmle_int…        368       19 2017-10-25 09:21:41</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a><span class="co">#&gt; # … with 36 more rows, and 36 more variables: start_time &lt;dttm&gt;,</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="co">#&gt; #   end_time &lt;dttm&gt;, failed &lt;int&gt;, exit_status &lt;int&gt;, ru_wallclock &lt;drtn&gt;,</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="co">#&gt; #   ru_utime &lt;drtn&gt;, ru_stime &lt;drtn&gt;, ru_maxrss &lt;chr&gt;, ru_ixrss &lt;chr&gt;,</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="co">#&gt; #   ru_ismrss &lt;chr&gt;, ru_idrss &lt;chr&gt;, ru_isrss &lt;chr&gt;, ru_minflt &lt;dbl&gt;,</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="co">#&gt; #   ru_majflt &lt;dbl&gt;, ru_nswap &lt;dbl&gt;, ru_inblock &lt;dbl&gt;, ru_oublock &lt;dbl&gt;,</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="co">#&gt; #   ru_msgsnd &lt;dbl&gt;, ru_msgrcv &lt;dbl&gt;, ru_nsignals &lt;dbl&gt;, ru_nvcsw &lt;dbl&gt;,</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="co">#&gt; #   ru_nivcsw &lt;dbl&gt;, project &lt;chr&gt;, department &lt;chr&gt;, granted_pe &lt;chr&gt;,</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="co">#&gt; #   slots &lt;int&gt;, task_number &lt;int&gt;, cpu &lt;drtn&gt;, mem &lt;chr&gt;, io &lt;chr&gt;,</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a><span class="co">#&gt; #   category &lt;chr&gt;, iow &lt;drtn&gt;, pe_taskid &lt;chr&gt;, maxvmem &lt;dbl&gt;, arid &lt;dbl&gt;,</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a><span class="co">#&gt; #   ar_sub_time &lt;dttm&gt;</span></span></code></pre></div>
</div>
<div id="statistics-on-these-jobs" class="section level2">
<h2>Statistics on these jobs</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="fu">range</span>(jobs<span class="sc">$</span>end_time, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Period: %s/%s</span><span class="sc">\n</span><span class="st">&quot;</span>, period[<span class="dv">1</span>], period[<span class="dv">2</span>]))</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt; Period: 2020-02-03 00:00:01/2020-02-16 23:59:58</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> <span class="fu">add_weeks</span>(jobs)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="fu">range</span>(jobs<span class="sc">$</span>end_time_week, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Period (weeks): %s/%s</span><span class="sc">\n</span><span class="st">&quot;</span>, period[<span class="dv">1</span>], period[<span class="dv">2</span>]))</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; Period (weeks): Period: 2020W06/2020W07</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Number of jobs finished during this period: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">nrow</span>(jobs)))</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">#&gt; Number of jobs finished during this period: 1290963</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>nusers <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(jobs<span class="sc">$</span>owner))</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Number of unique users: %d</span><span class="sc">\n</span><span class="st">&quot;</span>, nusers))</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co">#&gt; Number of unique users: 146</span></span></code></pre></div>
<p>Let’s see how many of the jobs finished succesfully and how many
failed.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="do">## Get successful and failed jobs</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>groups <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">success =</span> <span class="fu">subset</span>(jobs, failed <span class="sc">==</span> <span class="dv">0</span><span class="dt">L</span>),</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">fail    =</span> <span class="fu">subset</span>(jobs, failed <span class="sc">&gt;</span> <span class="dv">0</span><span class="dt">L</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>stats <span class="ot">&lt;-</span> <span class="fu">sapply</span>(groups, nrow)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="fu">print</span>(stats)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt; success    fail </span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt; 1227507   63456</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="fu">print</span>(stats<span class="sc">/</span><span class="fu">sum</span>(stats))</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">#&gt;  success     fail </span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co">#&gt; 0.950846 0.049154</span></span></code></pre></div>
<p>We see that failure rate among the ~1.3 million jobs that ran during
this period was ~5%. Next, let’s see how much CPU time this corresponds
to:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="do">## CPU time consumed</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>cpu <span class="ot">&lt;-</span> <span class="fu">lapply</span>(groups, <span class="cf">function</span>(jobs) { d <span class="ot">&lt;-</span> <span class="fu">sum</span>(jobs<span class="sc">$</span>cpu); <span class="fu">units</span>(d) <span class="ot">&lt;-</span> <span class="st">&quot;days&quot;</span>; d })</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">outcome =</span> <span class="fu">names</span>(cpu), <span class="at">cpu =</span> <span class="fu">do.call</span>(c, cpu))</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Total CPU processing time: %.1f %s</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="fu">sum</span>(total<span class="sc">$</span>cpu), <span class="fu">units</span>(total<span class="sc">$</span>cpu)))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt; Total CPU processing time: 53069.7 days</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">print</span>(total)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt;   outcome cpu          </span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;   &lt;drtn&gt;       </span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt; 1 success 37291.05 days</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt; 2 fail    15778.61 days</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="do">## CPU-time fractions</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>ratio <span class="ot">&lt;-</span> <span class="fu">mutate</span>(total, <span class="at">cpu =</span> { x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(cpu); x <span class="sc">/</span> <span class="fu">sum</span>(x) })</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="fu">print</span>(ratio)</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co">#&gt;   outcome   cpu</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co">#&gt; 1 success 0.703</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co">#&gt; 2 fail    0.297</span></span></code></pre></div>
<p>From this, we find that during these two weeks, ~30% of the CPU time
was consumed by jobs that failed. Among the failed jobs, the failure
code was distributed as:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>codes <span class="ot">&lt;-</span> groups<span class="sc">$</span>fail<span class="sc">$</span>failed</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(codes))</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt;    1     8    19    21    26    27    28    37   100 </span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt;    8    26  2520     8  2762    15 15552  9907 32658</span></span></code></pre></div>
<p>From details on these codes, see
<code>help(&quot;read_sge_accounting&quot;, package=&quot;wyntonquery&quot;)</code>, or:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">subset</span>(<span class="fu">sge_failed_codes</span>(), Code <span class="sc">%in%</span> <span class="fu">unique</span>(codes), <span class="at">select=</span><span class="fu">c</span>(Code, Explanation))</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 2</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#&gt;    Code Explanation                                                                                                       </span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;                                                                                                             </span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#&gt; 1     1 failed early in execd</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">#&gt; 2     8 failed in prolog</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">#&gt; 3    19 shepherd didnt write reports correctly - probably program or machine crash</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co">#&gt; 4    21 qmaster asked about an unknown job (not in accounting?)</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">#&gt; 5    26 failed opening stderr/stdout file</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co">#&gt; 6    27 failed finding specified shell</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="co">#&gt; 7    28 failed changing to start directory</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">#&gt; 8    37 ran, but killed due to exceeding run time limit</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="co">#&gt; 9   100 ran, but killed by a signal (perhaps due to exceeding resources),</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="co">#&gt;         task died, shepherd died (e.g. node crash), etc.</span></span></code></pre></div>
<p>The jobs that exhausted their limits, consumed 9,613 days of CPU
time;</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">subset</span>(groups<span class="sc">$</span>fail, failed <span class="sc">==</span> <span class="dv">37</span>)<span class="sc">$</span>cpu); <span class="fu">units</span>(d) <span class="ot">&lt;-</span> <span class="st">&quot;days&quot;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">print</span>(d)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co"># Time difference of 9613.036 days</span></span></code></pre></div>
<p>which corresponds to ~18% of all CPU time spent:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">as.numeric</span>(d)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">as.numeric</span>(total<span class="sc">$</span>cpu))</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.1811399</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
