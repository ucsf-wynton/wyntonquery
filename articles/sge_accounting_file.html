<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Henrik Bengtsson" />

<meta name="date" content="2021-10-14" />

<title>SGE Accounting File</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">SGE Accounting File</h1>
<h4 class="author">Henrik Bengtsson</h4>
<h4 class="date">2021-10-14</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The SGE accounting file holds information on all submitted and <em>finished</em> jobs submitted to the SGE scheduler. Queued or currently running jobs are <em>not</em> included in this file. A job is considered &quot;finished&quot; if it completed successfully, terminated due to an error, or was cancelled. The file is a colon-delimited text file with one job entry per row, with the most recently finished job appended at end. Contrary to what one might expect, the file is not <em>perfectly</em> ordered by the <code>end_time</code> of the jobs. We might find some entries where the <code>end_time</code> of two consequentive entries might differ by a few seconds in the &quot;wrong&quot; order. It's not clear to me why this is but it might be that the scheduler updates the SGE accounting file at regular intervals, say every few minutes, and when it does it goes through the jobs in order of job index.</p>
</div>
<div id="indexing-the-sge-accounting-file" class="section level2">
<h2>Indexing the SGE accounting file</h2>
<p>In March 2020, the Wynton HPC accounting file was ~12 GB and took 6-8 minutes to read. In June 2021, it was ~58 GB and had 161 million job entries. In October 2021, it was ~69 GB and had 192 million job entries. It is rare to be interested in all entries. It is more common to work with a subset of the job entries. In order to do this efficiently, we start by indexing the SGE accounting file to identify the file byte offset for each job entry;</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(wyntonquery)
<span class="kw">library</span>(progressr)
<span class="kw">handlers</span>(<span class="dt">global =</span> <span class="ot">TRUE</span>) ## Report on progress
<span class="kw">handlers</span>(<span class="kw">handler_progress</span>(
  <span class="st">&quot;:spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta&quot;</span>
))

pathname &lt;-<span class="st"> </span><span class="kw">sge_accounting_file</span>()
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;File size: %.3g GB</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">file.size</span>(pathname)<span class="op">/</span><span class="dv">1000</span><span class="op">^</span><span class="dv">3</span>))
<span class="co">#&gt; File size: 69.3 GB</span>

## It takes ~15 minutes to index a 69 GB SGE accounting file
index &lt;-<span class="st"> </span><span class="kw">make_file_index</span>(pathname, <span class="dt">skip =</span> 4L)
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Number of job entries: %d</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">length</span>(index)))
<span class="co">#&gt; Number of job entries: 191745505</span>

## Save per-job index to file
<span class="kw">save_file_index</span>(index, <span class="dt">file =</span> <span class="st">&quot;accounting.index_by_row&quot;</span>)</code></pre></div>
<p>Next, we want to group the job entries by the ISO-6801 week of the job end times.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(wyntonquery)
<span class="kw">library</span>(progressr)
<span class="kw">handlers</span>(<span class="dt">global =</span> <span class="ot">TRUE</span>) ## Report on progress
<span class="kw">handlers</span>(<span class="kw">handler_progress</span>(
  <span class="st">&quot;:spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta&quot;</span>
))

pathname &lt;-<span class="st"> </span><span class="kw">sge_accounting_file</span>()
index &lt;-<span class="st"> </span><span class="kw">read_file_index</span>(<span class="st">&quot;accounting.index_by_row&quot;</span>)
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Number of job entries: %d</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">length</span>(index)))
<span class="co">#&gt; Number of job entries: 191745505</span>

## It takes ~15 minutes to build the week index for 192 million entries
week_index &lt;-<span class="st"> </span><span class="kw">sge_make_week_index</span>(pathname, <span class="dt">index =</span> index)
<span class="kw">saveRDS</span>(week_index, <span class="dt">file =</span> <span class="st">&quot;accounting.index_by_week.rds&quot;</span>)

<span class="kw">print</span>(week_index)
<span class="co">#&gt; # A tibble: 218 × 3</span>
<span class="co">#&gt;    week    nbr_of_jobs file_offset</span>
<span class="co">#&gt;    &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 2017W33         406          59</span>
<span class="co">#&gt;  2 2017W34          44      113195</span>
<span class="co">#&gt;  3 2017W35          49      127727</span>
<span class="co">#&gt;  4 2017W36          24      143361</span>
<span class="co">#&gt;  5 2017W37           8      150740</span>
<span class="co">#&gt;  6 2017W38          30      153559</span>
<span class="co">#&gt;  7 2017W39          18      163657</span>
<span class="co">#&gt;  8 2017W40          22      169804</span>
<span class="co">#&gt;  9 2017W41           2      177075</span>
<span class="co">#&gt; 10 2017W42          18      177695</span>
<span class="co">#&gt; # … with 208 more rows</span></code></pre></div>
</div>
<div id="reading-job-entries-in-sge-accounting-file" class="section level2">
<h2>Reading job entries in SGE accounting file</h2>
<p>Here is an example how we can read the job entries for a couple of weeks:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(wyntonquery)
<span class="kw">library</span>(dplyr)

pathname &lt;-<span class="st"> </span><span class="kw">sge_accounting_file</span>()
week_index &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;accounting.index_by_week.rds&quot;</span>)

weeks &lt;-<span class="st"> </span><span class="kw">subset</span>(week_index, week <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2020W06&quot;</span>, <span class="st">&quot;2020W07&quot;</span>))
<span class="kw">print</span>(weeks)
<span class="co">#&gt; # A tibble: 2 × 3</span>
<span class="co">#&gt;   week    nbr_of_jobs file_offset</span>
<span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2020W06      627479 11015936052</span>
<span class="co">#&gt; 2 2020W07      663484 11229385140</span>

offset &lt;-<span class="st"> </span>weeks<span class="op">$</span>file_offset[<span class="dv">1</span>]
n_max &lt;-<span class="st"> </span><span class="kw">sum</span>(weeks<span class="op">$</span>nbr_of_jobs)
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Number of job entries to read: %d</span><span class="ch">\n</span><span class="st">&quot;</span>, n_max))
<span class="co">#&gt; Number of job entries to read: 1290963</span>

## It takes ~5 seconds to read the ~1.3 million job entries of interest
jobs &lt;-<span class="st"> </span><span class="kw">read_sge_accounting</span>(pathname, <span class="dt">offset =</span> offset, <span class="dt">n_max =</span> n_max)
jobs &lt;-<span class="st"> </span><span class="kw">anonymize</span>(jobs)
<span class="kw">print</span>(<span class="kw">head</span>(<span class="kw">select</span>(jobs, <span class="op">-</span>account)))
<span class="co">#&gt; # A tibble: 6 × 44</span>
<span class="co">#&gt;    qname  hostname group owner job_name  job_number priority submission_time    </span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;          &lt;int&gt;    &lt;int&gt; &lt;dttm&gt;             </span>
<span class="co">#&gt;  1 long.q cc-id3   grou… owne… job_qb3.…        361       19 2017-10-24 09:33:46</span>
<span class="co">#&gt;  2 long.q cin-id2  grou… owne… job_qb3.…        360       19 2017-10-23 16:09:59</span>
<span class="co">#&gt;  3 long.q qb3-hmi… grou… owne… job_qb3.…        365       19 2017-10-24 12:01:17</span>
<span class="co">#&gt;  4 long.q qb3-id3  grou… owne… job_mac_…        359       19 2017-10-23 09:52:44</span>
<span class="co">#&gt;  5 long.q qb3-id2  grou… owne… job_qb3.…        363       19 2017-10-24 09:41:57</span>
<span class="co">#&gt;  6 long.q qb3-id1  grou… owne… bmle_int…        368       19 2017-10-25 09:21:41</span>
<span class="co">#&gt; # … with 36 more rows, and 36 more variables: start_time &lt;dttm&gt;,</span>
<span class="co">#&gt; #   end_time &lt;dttm&gt;, failed &lt;int&gt;, exit_status &lt;int&gt;, ru_wallclock &lt;drtn&gt;,</span>
<span class="co">#&gt; #   ru_utime &lt;drtn&gt;, ru_stime &lt;drtn&gt;, ru_maxrss &lt;chr&gt;, ru_ixrss &lt;chr&gt;,</span>
<span class="co">#&gt; #   ru_ismrss &lt;chr&gt;, ru_idrss &lt;chr&gt;, ru_isrss &lt;chr&gt;, ru_minflt &lt;dbl&gt;,</span>
<span class="co">#&gt; #   ru_majflt &lt;dbl&gt;, ru_nswap &lt;dbl&gt;, ru_inblock &lt;dbl&gt;, ru_oublock &lt;dbl&gt;,</span>
<span class="co">#&gt; #   ru_msgsnd &lt;dbl&gt;, ru_msgrcv &lt;dbl&gt;, ru_nsignals &lt;dbl&gt;, ru_nvcsw &lt;dbl&gt;,</span>
<span class="co">#&gt; #   ru_nivcsw &lt;dbl&gt;, project &lt;chr&gt;, department &lt;chr&gt;, granted_pe &lt;chr&gt;,</span>
<span class="co">#&gt; #   slots &lt;int&gt;, task_number &lt;int&gt;, cpu &lt;drtn&gt;, mem &lt;chr&gt;, io &lt;chr&gt;,</span>
<span class="co">#&gt; #   category &lt;chr&gt;, iow &lt;drtn&gt;, pe_taskid &lt;chr&gt;, maxvmem &lt;dbl&gt;, arid &lt;dbl&gt;,</span>
<span class="co">#&gt; #   ar_sub_time &lt;dttm&gt;</span></code></pre></div>
</div>
<div id="statistics-on-these-jobs" class="section level2">
<h2>Statistics on these jobs</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">period &lt;-<span class="st"> </span><span class="kw">range</span>(jobs<span class="op">$</span>end_time, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Period: %s/%s</span><span class="ch">\n</span><span class="st">&quot;</span>, period[<span class="dv">1</span>], period[<span class="dv">2</span>]))
<span class="co">#&gt; Period: 2020-02-03 00:00:01/2020-02-16 23:59:58</span>

jobs &lt;-<span class="st"> </span><span class="kw">add_weeks</span>(jobs)
period &lt;-<span class="st"> </span><span class="kw">range</span>(jobs<span class="op">$</span>end_time_week, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Period (weeks): %s/%s</span><span class="ch">\n</span><span class="st">&quot;</span>, period[<span class="dv">1</span>], period[<span class="dv">2</span>]))
<span class="co">#&gt; Period (weeks): Period: 2020W06/2020W07</span>

<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Number of jobs finished during this period: %d</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">nrow</span>(jobs)))
<span class="co">#&gt; Number of jobs finished during this period: 1290963</span>

nusers &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(jobs<span class="op">$</span>owner))
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Number of unique users: %d</span><span class="ch">\n</span><span class="st">&quot;</span>, nusers))
<span class="co">#&gt; Number of unique users: 146</span></code></pre></div>
<p>Let's see how many of the jobs finished succesfully and how many failed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Get successful and failed jobs
groups &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">success =</span> <span class="kw">subset</span>(jobs, failed <span class="op">==</span><span class="st"> </span>0L),
  <span class="dt">fail    =</span> <span class="kw">subset</span>(jobs, failed <span class="op">&gt;</span><span class="st"> </span>0L)
)
stats &lt;-<span class="st"> </span><span class="kw">sapply</span>(groups, nrow)
<span class="kw">print</span>(stats)
<span class="co">#&gt; success    fail </span>
<span class="co">#&gt; 1227507   63456</span>

<span class="kw">print</span>(stats<span class="op">/</span><span class="kw">sum</span>(stats))
<span class="co">#&gt;  success     fail </span>
<span class="co">#&gt; 0.950846 0.049154</span></code></pre></div>
<p>We see that failure rate among the ~1.3 million jobs that ran during this period was ~5%. Next, let's see how much CPU time this corresponds to:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## CPU time consumed
cpu &lt;-<span class="st"> </span><span class="kw">lapply</span>(groups, <span class="cf">function</span>(jobs) { d &lt;-<span class="st"> </span><span class="kw">sum</span>(jobs<span class="op">$</span>cpu); <span class="kw">units</span>(d) &lt;-<span class="st"> &quot;days&quot;</span>; d })
total &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">outcome =</span> <span class="kw">names</span>(cpu), <span class="dt">cpu =</span> <span class="kw">do.call</span>(c, cpu))
<span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Total CPU processing time: %.1f %s</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">sum</span>(total<span class="op">$</span>cpu), <span class="kw">units</span>(total<span class="op">$</span>cpu)))
<span class="co">#&gt; Total CPU processing time: 53069.7 days</span>

<span class="kw">print</span>(total)
<span class="co">#&gt;   outcome cpu          </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;drtn&gt;       </span>
<span class="co">#&gt; 1 success 37291.05 days</span>
<span class="co">#&gt; 2 fail    15778.61 days</span>

## CPU-time fractions
ratio &lt;-<span class="st"> </span><span class="kw">mutate</span>(total, <span class="dt">cpu =</span> { x &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(cpu); x <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(x) })
<span class="kw">print</span>(ratio)
<span class="co">#&gt; # A tibble: 2 × 2</span>
<span class="co">#&gt;   outcome   cpu</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 success 0.703</span>
<span class="co">#&gt; 2 fail    0.297</span></code></pre></div>
<p>From this, we find that during these two weeks, ~30% of the CPU time was consumed by jobs that failed. Among the failed jobs, the failure code was distributed as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">codes &lt;-<span class="st"> </span>groups<span class="op">$</span>fail<span class="op">$</span>failed
<span class="kw">print</span>(<span class="kw">table</span>(codes))
<span class="co">#&gt;    1     8    19    21    26    27    28    37   100 </span>
<span class="co">#&gt;    8    26  2520     8  2762    15 15552  9907 32658</span></code></pre></div>
<p>From details on these codes, see <code>help(&quot;read_sge_accounting&quot;, package=&quot;wyntonquery&quot;)</code>, or:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">subset</span>(<span class="kw">sge_failed_codes</span>(), Code <span class="op">%in%</span><span class="st"> </span><span class="kw">unique</span>(codes), <span class="dt">select=</span><span class="kw">c</span>(Code, Explanation))
<span class="co">#&gt; # A tibble: 9 × 2</span>
<span class="co">#&gt;    Code Explanation                                                                                                       </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;                                                                                                             </span>
<span class="co">#&gt; 1     1 failed early in execd</span>
<span class="co">#&gt; 2     8 failed in prolog</span>
<span class="co">#&gt; 3    19 shepherd didnt write reports correctly - probably program or machine crash</span>
<span class="co">#&gt; 4    21 qmaster asked about an unknown job (not in accounting?)</span>
<span class="co">#&gt; 5    26 failed opening stderr/stdout file</span>
<span class="co">#&gt; 6    27 failed finding specified shell</span>
<span class="co">#&gt; 7    28 failed changing to start directory</span>
<span class="co">#&gt; 8    37 ran, but killed due to exceeding run time limit</span>
<span class="co">#&gt; 9   100 ran, but killed by a signal (perhaps due to exceeding resources),</span>
<span class="co">#&gt;         task died, shepherd died (e.g. node crash), etc.</span></code></pre></div>
<p>The jobs that exhausted their limits, consumed 9,613 days of CPU time;</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">subset</span>(groups<span class="op">$</span>fail, failed <span class="op">==</span><span class="st"> </span><span class="dv">37</span>)<span class="op">$</span>cpu); <span class="kw">units</span>(d) &lt;-<span class="st"> &quot;days&quot;</span>
<span class="kw">print</span>(d)
<span class="co"># Time difference of 9613.036 days</span></code></pre></div>
<p>which corresponds to ~18% of all CPU time spent:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="op">&gt;</span><span class="st"> </span><span class="kw">as.numeric</span>(d)<span class="op">/</span><span class="kw">sum</span>(<span class="kw">as.numeric</span>(total<span class="op">$</span>cpu))
[<span class="dv">1</span>] <span class="fl">0.1811399</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
